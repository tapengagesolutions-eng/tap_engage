<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tap Engage - Master Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .card { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 5px 10px -5px rgba(0, 0, 0, 0.04); }
        .btn-primary { transition: background-color 0.3s, transform 0.2s; }
        .btn-primary:hover { background-color: #1a56db; transform: translateY(-1px); }
        .status-pill { padding: 4px 8px; border-radius: 9999px; font-weight: 600; font-size: 0.75rem; }
        .status-New { background-color: #fef3c7; color: #a16207; } /* Amber */
        .status-In-Progress { background-color: #dbeafe; color: #1e40af; } /* Blue */
        .status-Complete { background-color: #d1fae5; color: #065f46; } /* Green */
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-4 mb-8">
        <h1 class="text-3xl font-bold text-gray-800 flex items-center space-x-3 mb-4 sm:mb-0">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.3-.872-2.885.343-2.288 1.638a1.532 1.532 0 01-.582 2.286c-1.56.38-1.56 2.6 0 2.98a1.532 1.532 0 01.582 2.286c-.597 1.295.91 2.502 2.286 1.638a1.532 1.532 0 012.286.948c.379 1.56 2.6 1.56 2.98 0a1.532 1.532 0 012.286-.948c1.3.872 2.885-.343 2.288-1.638a1.532 1.532 0 01.582-2.286c1.56-.38 1.56-2.6 0-2.98a1.532 1.532 0 01-.582-2.286c.597-1.295-.91-2.502-2.286-1.638a1.532 1.532 0 01-2.286-.948zM10 11a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
            </svg>
            Tap Engage Master Dashboard
        </h1>
        <a href="./intake.html" class="w-full sm:w-auto bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg text-center btn-primary">
            + New Client Intake
        </a>
    </header>

    <div id="loadingMessage" class="flex items-center space-x-2 text-indigo-600 font-medium p-4 bg-indigo-50 rounded-lg">
        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <span>Loading client intakes from database...</span>
    </div>

    <div id="clientList" class="space-y-4">
        <!-- Client Intake Cards will be inserted here -->
    </div>

    <p id="noDataMessage" class="hidden mt-8 text-center text-gray-500 p-8 bg-white rounded-xl card">
        No client intake data found yet. Click "+ New Client Intake" to get started.
    </p>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables from the Canvas environment are injected here.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        setLogLevel('error'); // Set to error to keep the console clean unless serious issues occur.

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const clientList = document.getElementById('clientList');
        const loadingMessage = document.getElementById('loadingMessage');
        const noDataMessage = document.getElementById('noDataMessage');

        // Utility to format timestamp
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Utility to create the HTML card for a client intake
        function createClientCard(doc) {
            const data = doc.data();
            const card = document.createElement('div');
            card.className = 'card bg-white p-6 rounded-xl hover:shadow-lg transition duration-300';
            card.innerHTML = `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-3 mb-3">
                    <h2 class="text-xl font-semibold text-gray-900 truncate">${data.clientName}</h2>
                    <span class="status-pill status-${data.status.replace(/\s/g, '-')}" title="Status">${data.status}</span>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-y-2 text-sm text-gray-600">
                    <div>
                        <span class="font-medium text-gray-800">Email:</span> 
                        <a href="mailto:${data.clientEmail}" class="text-indigo-600 hover:underline">${data.clientEmail}</a>
                    </div>
                    <div class="truncate">
                        <span class="font-medium text-gray-800">Submitted:</span> 
                        ${formatTimestamp(data.createdAt)}
                    </div>
                    <div class="truncate">
                        <span class="font-medium text-gray-800">ID:</span> 
                        <span title="${doc.id}">${doc.id.substring(0, 8)}...</span>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t">
                    <p class="font-medium text-gray-800 mb-1">Project Details:</p>
                    <p class="text-sm text-gray-700 whitespace-pre-wrap">${data.projectDetails}</p>
                </div>
            `;
            return card;
        }

        async function initFirebase() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                // Once authenticated, start listening for data changes
                listenForIntakes();

            } catch (error) {
                console.error("Firebase Auth Error:", error);
                loadingMessage.innerHTML = '<span class="text-red-600 font-medium">Error: Could not authenticate to load data.</span>';
            }
        }

        function listenForIntakes() {
            // Define the collection path for public data: 
            // /artifacts/{appId}/public/data/client_intakes
            const collectionPath = `artifacts/${appId}/public/data/client_intakes`;
            const q = query(collection(db, collectionPath));
            
            // onSnapshot listens for real-time updates
            onSnapshot(q, (snapshot) => {
                loadingMessage.classList.add('hidden');
                clientList.innerHTML = ''; // Clear existing list

                if (snapshot.empty) {
                    noDataMessage.classList.remove('hidden');
                } else {
                    noDataMessage.classList.add('hidden');
                    snapshot.forEach(doc => {
                        const card = createClientCard(doc);
                        clientList.appendChild(card);
                    });
                }
            }, (error) => {
                console.error("Firestore data listener error:", error);
                loadingMessage.innerHTML = '<span class="text-red-600 font-medium">Error loading data. Check console.</span>';
            });
        }

        initFirebase();
    </script>
</body>
</html>


