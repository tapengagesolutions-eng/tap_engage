<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tap Engage - Client Intake</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; }
        .card { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 5px 10px -5px rgba(0, 0, 0, 0.04); }
        .btn-primary { transition: background-color 0.3s, transform 0.2s; }
        .btn-primary:hover { background-color: #1a56db; transform: translateY(-1px); }
        .input-group { position: relative; }
        .input-group input:focus ~ label, .input-group textarea:focus ~ label,
        .input-group input:not(:placeholder-shown) ~ label, .input-group textarea:not(:placeholder-shown) ~ label {
            top: -10px; font-size: 0.75rem; color: #4f46e5; background-color: white; padding: 0 4px; }
        .input-group label { transition: all 0.2s ease-in-out; pointer-events: none; position: absolute; left: 12px; top: 14px; color: #9ca3af; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="loadingMessage" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg flex items-center space-x-3 shadow-xl">
            <svg class="animate-spin h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p id="loadingText" class="text-indigo-600 font-medium">Submitting intake...</p>
        </div>
    </div>

    <div class="w-full max-w-xl bg-white p-8 rounded-xl card">
        <div class="flex items-center space-x-3 mb-6 border-b pb-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600" viewBox="0 0 20 20" fill="currentColor">
                <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 10a1 1 0 011-1h10a1 1 0 010 2H5a1 1 0 01-1-1zm-1 4a1 1 0 000 2h14a1 1 0 000-2H3z" />
            </svg>
            <h1 class="text-3xl font-bold text-gray-800">Client Intake Form</h1>
        </div>

        <form id="intakeForm" class="space-y-6">

            <div class="input-group">
                <input type="text" id="clientName" required placeholder=" " class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <label for="clientName">Client Name</label>
            </div>

            <div class="input-group">
                <input type="email" id="clientEmail" required placeholder=" " class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <label for="clientEmail">Client Email</label>
            </div>

            <div class="input-group">
                <textarea id="projectDetails" rows="5" required placeholder=" " class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                <label for="projectDetails">Project Details/Goals</label>
            </div>

            <div id="messageBox" class="p-3 rounded-lg text-sm hidden"></div>

            <button type="submit" id="submitBtn" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg btn-primary">
                Submit Intake
            </button>
        </form>

        <a href="./dashboard.html" class="mt-4 block text-center text-sm text-indigo-600 hover:text-indigo-800 transition duration-150">
            &larr; Back to Dashboard
        </a>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables from the Canvas environment are injected here.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        setLogLevel('error'); // Set to error to keep the console clean unless serious issues occur.

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const form = document.getElementById('intakeForm');
        const submitBtn = document.getElementById('submitBtn');
        const messageBox = document.getElementById('messageBox');
        const loadingMessage = document.getElementById('loadingMessage');
        const loadingText = document.getElementById('loadingText');

        // Function to display messages (replaces alert())
        function displayMessage(text, type = 'success') {
            messageBox.textContent = text;
            messageBox.className = 'p-3 rounded-lg text-sm';
            messageBox.classList.remove('hidden');
            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-800');
            }
        }

        async function initFirebase() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                // Use the authenticated user's ID or a random ID if anonymous
                const userId = auth.currentUser?.uid || crypto.randomUUID();
                return userId;

            } catch (error) {
                console.error("Firebase Auth Error:", error);
                displayMessage("Authentication failed. Cannot submit data.", 'error');
                return null;
            }
        }

        initFirebase().then(userId => {
            if (!userId) return;

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                loadingText.textContent = 'Submitting intake...';
                loadingMessage.classList.remove('hidden');
                submitBtn.disabled = true;
                messageBox.classList.add('hidden');

                const clientName = document.getElementById('clientName').value;
                const clientEmail = document.getElementById('clientEmail').value;
                const projectDetails = document.getElementById('projectDetails').value;

                // Define the collection path for public data: 
                // /artifacts/{appId}/public/data/client_intakes
                const collectionPath = `artifacts/${appId}/public/data/client_intakes`;
                
                const clientData = {
                    submittedBy: userId,
                    clientName: clientName,
                    clientEmail: clientEmail,
                    projectDetails: projectDetails,
                    status: 'New Intake',
                    createdAt: serverTimestamp()
                };

                try {
                    await addDoc(collection(db, collectionPath), clientData);
                    
                    displayMessage('Success! Client data saved to the database. Redirecting to dashboard...', 'success');
                    form.reset();
                    
                    setTimeout(() => {
                        window.location.href = './dashboard.html';
                    }, 2000);

                } catch (error) {
                    console.error("Firestore submission error:", error);
                    displayMessage('Error saving data. Check console for details.', 'error');
                } finally {
                    loadingMessage.classList.add('hidden');
                    submitBtn.disabled = false;
                }
            });
        });

    </script>
</body>
</html>


